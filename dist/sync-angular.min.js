/*! sync-angular 23-07-2014 */
var SyncObject=function(a){"use strict";var b=this;this.syncTimeout=2e3;var c,d=function(){return"undefined"!=typeof c?c:navigator.onLine},e=function(){return window.localStorage[b.prefix+"_index"]?JSON.parse(window.localStorage[b.prefix+"_index"]):[]},f=function(a){a&&(window.localStorage[b.prefix+"_index"]=JSON.stringify(a))};b.clearAll=function(){for(var a=_.keys(localStorage),c=0;c<a.length;c++)a[c].match(b.prefix)&&delete window.localStorage[a[c]]};var g=function(a){var b=e();b.push(a),f(b)},h=function(a){return!!_.find(e(),function(b){return a==b})},i=function(a){var b=e();b=_.filter(b,function(b){return a!=b}),f(b)};this.pk=null;var j=function(a){for(var c=[],d=0;d<b.pk.length;d++)c.push(a[b.pk[d]]);return c.join()};try{var k=window.localStorage}catch(l){return console.log("Local Storage is not supported in this browser. Data cannot be saved offline"),!1}this.prefix="_syncProvider_",this.sync=function(){for(var a=m(),c=0;c<a.length;c++){var d=o(a[c]);b.pk instanceof Array?b.saveToServer(a[c].split(","),d):r(a[c])?(d[b.pk]=null,b.saveToServer(null,d)):s(a[c])?(deleteFromServer(a[c]),u(a[c])):b.saveToServer(a[c],d),u(a[c])}b.getAllFromServer()};var m=function(){for(var a=[],c=e(),d=0;d<c.length;d++)if(k[b.prefix+c[d]]){var f=JSON.parse(k[b.prefix+c[d]]);f.dirty===!0&&a.push(c[d])}return a};this.saveToServer=function(){console.log("saveToServer function not configured yet, check provider configuration to set this method")},this.getAllFromServer=function(){console.log("getAll function not set yet, check provider configuration to set this method")},this.lsFilter=null;var n=function(a){for(var c=[],d=e(),f=0;f<d.length;f++){var g=o(d[f]);"undefined"==typeof g[b.pk]&&g.newRecord===!0&&(g[b.pk]=g.saKey),g&&!g.deleted&&c.push(g)}if(b.lsFilter){for(var h=[],f=0;f<c.length;f++)b.lsFilter(c[f],a)&&h.push(c[f]);return b.postProcessingLS&&(h=b.postProcessingLS(h)),h}return"undefined"!=typeof postProcessingLS&&(c=postProcessingLS(c)),c};this.getFromServer=function(a){console.log(a?"getFromServer function not set yet, check provider configuration to set this method":"No key provided, ensure that a key parameter is passed in")},this.deleteFromServer=function(){console.log("Delete from server method not specified. use .setDeleteFromServer()")};var o=function(a){var c={};if(a){if(a instanceof Array){if(k[b.prefix+a.join()]){var c=JSON.parse(k[b.prefix+a.join()]).record;return c.saKey=a,c}return null}if(k[b.prefix+a]){var c=JSON.parse(k[b.prefix+a]).record;return c&&(c.saKey=a),c}return null}console.log("No key provided, ensure that a key parameter is passed in")},p=function(a,c,d){return a?a instanceof Array?h(a.join())?k[b.prefix+a.join()]=JSON.stringify({dirty:d,record:c,newRecord:!1}):(k[b.prefix+a.join()]=JSON.stringify({dirty:d,record:c}),g(a.join())):h(a)&&!a.match(/saKey/)?k[b.prefix+a]=JSON.stringify({dirty:d,record:c,newRecord:!1}):h(a)&&a.match(/saKey/)?k[b.prefix+a]=JSON.stringify({dirty:d,record:c,newRecord:!0}):(k[b.prefix+a]=JSON.stringify({dirty:d,record:c}),g(a)):(a=t(),c.saKey=a,c[b.pk]=a,k[b.prefix+a]=JSON.stringify({dirty:d,record:c,newRecord:!0}),g(a)),{success:function(a){a(c)}}},q=function(a){return a&&(a instanceof Array?h(a.join())&&(k[b.prefix+a.join()]=JSON.stringify({dirty:!0,deleted:!0})):h(a)&&(k[b.prefix+a]=JSON.stringify({dirty:!0,deleted:!0}))),{success:function(a){a()}}},r=function(a){return JSON.parse(k[b.prefix+a]).newRecord},s=function(a){return JSON.parse(k[b.prefix+a]).deleted},t=function(){return"saKey"+parseInt(Date.now()+1e3*Math.random())},u=function(a){a?a instanceof Array?(delete k[b.prefix+a.join()],i(a.join())):(delete k[b.prefix+a],i(a)):console.log("No key provided, ensure that a key parameter is passed in")},v=function(){console.log("Offline detected by Syncprovider")};return this.goOnline=function(){console.log("Online detected by Syncprovider"),setTimeout(function(){console.log("Syncing"),b.sync()},b.syncTimeout)},window.addEventListener("offline",function(){v()}),window.addEventListener("online",function(){b.goOnline()}),this.get=function(a){return d()?b.getFromServer(a):{success:function(b){b(o(a))}}},this.getAll=function(a,e){if("undefined"==typeof e&&(e=!0),d())return c&&console.log("getting all from server"),b.getAllFromServer(a).error(function(a){console.error(a)}).success(function(a){if(a&&e){if("undefined"==typeof b.pk)throw'Primary Key not configured in offline sync adapter. Use "pk" as a parameter in config';if(b.pk instanceof Array)for(var c=0;c<a.length;c++)p(j(a[c]),a[c],!1);else for(var c=0;c<a.length;c++)"undefined"!=typeof a[c][b.pk]?p(a[c][b.pk],a[c],!1):null!==b.pk&&void 0!=b.pk&&(console.error("Error while trying to save data locally. Appear to be a problem with PK as an index into the results. Key:",b.pk),console.log("Data being inserted into:",a[c],"with: ",a[c][b.pk]))}return{success:function(b){b(a)}}});c&&console.log("getting all from local storage");var f=n(a);return{success:function(a){a(f)}}},this.rmLS=function(a){u(a)},this.clearLS=function(){b.clearAll()},this.save=function(a,c){return d()?b.saveToServer(a,c):p(a,c,!0)},this.delete=function(a){return d()?(u(a),deleteFromServer(a)):q(a)},b.testing=function(a){return"boolean"==typeof a&&(c=a),d()},this.postProcessingLS=null,_.extend(this,a)};